---
layout: post
title:  "프로젝트 공동주택 공시가격 API"
subtitle:   ""
categories: learn
tags : learn
comments: true
---
# 공동주택 공시가격 API

[https://github.com/HoseungJang/declaredValueAPI](https://github.com/HoseungJang/declaredValueAPI)

#### 공동주택 공시가격 API는 무엇인가

 겨울방학동안 스타트업에서 2달동안 인턴으로 근무하면서 진행한 프로젝트입니다. 지번주소, 도로명주소 검색 모두 가능하며, 공동주택의 공시가격 정보를 제공해줍니다.

## 얻은 점

#### 빌드/테스트/배포 자동화!

 처음으로 자동화라는 것을 구축해보았습니다. Travis CI로 빌드/테스트를 자동화하고, AWS S3, AWS CodeDeploy, Docker, NginX로 배포를 자동화하였습니다. 지금까지 써보지 않았던 AWS의 여러 기능들을 사용해볼 수 있었고, 여러가지 스크립트 파일을 작성하는 것도 처음 해보는 것이어서 즐거웠습니다. 예전 프로젝트에서는 배포를 할 때 EC2에 pull해오고, 서버를 재가동 시켰을 때 에러가 나면 로컬에서 수정하고 commit, push, 다시 pull 하는 것을 반복했습니다. 확실히 자동화를 구축해보고 나니 예전 방식이 얼마나 위험하고 효율이 떨어지는 방식이었는지 깨닫게 되었습니다.

#### Docker 첫 사용기

 Docker를 프로젝트에 처음 사용해보았습니다. 예전 프로젝트에서는 그냥 EC2에 직접 개발환경을 구축하였지만, Docker를 사용하니 그런 수작업을 해줄 필요가 없어졌습니다. Dockerfile에 Node.js 버전을 명시해주고, COPY, CMD 등의 키워드로 이미지, 그리고 컨테이너에 실행시킬 여러 스크립트를 작성해주고 이미지를 빌드하면 개발환경 수작업은 끝이었고, docker-compose라는 매우 편하게 컨테이너를 다룰 수 있는 도구로 위에서 빌드했던 이미지를 컨테이너로 실행시키면 Dockerfile에서 설정한 스크립트가 컨테이너에서 실행되므로 배포 수작업도 끝이었습니다. 거기다가 위에서 구축한 자동화로 컨테이너 실행/정지 수작업도 끝이 나버렸으니, 확실히 예전 방식보다 편해졌습니다. 그리고 Docker를 사용하면서 가장 마음에 들었던 점이 마치 새로운 틀에 찍어내듯이 간편하게 새로운 버전을 배포하고, 이전 버전을 버릴 수 있다는 점이었습니다.

#### 중단 없는 서비스

 NginX, Docker를 통해서 블루/그린 방식의 무중단 배포를 구축해보았습니다. NginX 설정파일에서 환경 변수를 가져다 쓰게 설정하여 배포 스크립트가 실행될 때 마다 환경 변수 값을 바꾸어 포트 두 개를 번갈아 가며 트래픽을 보내도록 했습니다. 예전 방식에서의 단점은 서비스의 중단이 무조건적으로 발생한다는 점이었습니다. 하지만 무중단 배포를 구축함으로써 서비스의 중단이 발생하지 않고도 배포를 성공적으로 해낼 수 있었습니다.

#### 이런 테스트는 처음이지?

 예전 프로젝트에서는 Postman을 사용해서 모든 API테스트를 진행하였습니다. 하지만 이번 프로젝트에서는 Mocha와 Travis CI를 사용하게 되어 테스트 코드를 통해 API테스트를 하게 되었습니다. 예전에는 테스트와 배포를 수작업으로 하다보니 놓치는 부분이 상당수였고, 크래쉬가 엄청나게 발생했습니다. 또한 에러 하나를 고치더라도 또 다른 에러가 바로 생겨버리는 것이 반복되는 경우가 있었는데, 이런 경우 에러가 보이지 않을 때 까지 계속해서 서비스가 중단되는 심각한 상황이 벌어졌습니다. 하지만 철저한 테스트 코드를 작성해두고, 원격저장소에 push했을 때 문제가 발생하면 CI 단계에서 실패하고 넘어가지 않으므로 예전 방식보다 매우 안전하고, 또한 빠뜨리는 부분 없이 체계적으로 테스트를 진행할 수 있었습니다.

#### 테스트와 개발, 둘 중에 누가 먼저야?

 저는 개발을 먼저하고 그에 맞춰서 테스트 코드를 작성하는 방식으로 이번 프로젝트를 진행했습니다. 하지만 프로젝트가 끝나고 나서 어딘가 조금 이상한 기분이 들었습니다. 테스트를 통과시키기 위해서 개발을 철저하게 하는게 맞는 것 같은데, 제 방식에서는 개발된 API에 맞춰서 테스트 코드를 작성하는 느낌이었습니다. 그래서 고민을 하던 중에 TDD라는 것을 발견했습니다. 확실히 테스트가 개발을 주도하게 되면, 테스트 코드는 공격적으로 작성하게 될 것이고, 개발을 방어적으로 하게 될 것입니다. 그러면 확실히 더 완고한 결과물을 기대할 수 있을 것 같고, 앞으로 새롭게 진행할 프로젝트에서는 TDD를 적용해 봐야겠습니다.

#### DB 서버는 분리하자

 예전 프로젝트에서는 DB가 EC2 인스턴스에 포함되어 있었습니다. 이 방식의 가장 큰 단점은 문제가 생겼을 때 특정 지점으로 돌아가서 데이터를 복원할 수가 없다는 것이었습니다. EC2를 복원할 수 있는 방법이 있는지는 잘 모르겠지만, 방법이 있다고 해도 데이터베이스 자체만 복원하는게 아니라 EC2 인스턴스 전체가 해당 복원 지점으로 돌아가는 것이므로 좋은 방법이 아닌 것 같았습니다. 그래서 이번에는 AWS RDS에 MySQL 인스턴스를 생성하여 DB 서버는 따로 분리하였습니다. AWS RDS를 사용함으로써 언제든지 스냅샷을 통해서 인스턴스를 복제하여 특정 시점의 데이터를 복원할 수 있었습니다.

#### 국가기관의 데이터도 맹신할 수는 없다

 공동주택의 공시가격을 제공하기 위해서는 당연히 공동주택 공시가격의 데이터가 필요했습니다. 때마침 공공데이터 포털에서 국토교통부가 매년 공개하는 공동주택 공시가격 데이터를 확인할 수 있었습니다. 나름 국가기관에서 공개하는 데이터니까 문제가 전혀 없을 줄 알았지만, 도로명주소에 도로명이 누락되 있는 등 문제가 있는 데이터가 정말 많았고, 그것들을 처리하는데에 3~4일 정도를 소비했습니다. 아무리 국가기관에서 공개하는 데이터라도 약 1400만개의 많은 데이터를 모두 맹신하는 것은 위험한 일이라는 것을 깨달았습니다.

#### API를 웹처럼 만들면 안된다

 처음 API를 설계할 때 모티브로 삼은 것은 국토교통부의 부동산 공시가격 알리미 사이트였습니다. 예를들어 사용자가 도로명주소로 공시가격을 확인하려면, 시/도, 시/군/구, 도로명, 단지명, 동, 호를 순차적으로 선택해야 했습니다. 그래서 저도 시/도 리스트, 시/군/구 리스트, 도로명 리스트, 단지명 리스트, 동 리스트, 호 리스트를 차례대로 제공하며 최종적으로 공시가격 데이터를 제공하는 방식으로 API를 설계하고 개발을 마쳤습니다. 하지만 개발팀장님과 이야기하다보니 웹에서는 그렇게 사용될 수 있지만 API를 가져다 쓰는 사용자 입장에서는 더 많은 옵션들을 원할 수 있다는 것을 깨달았습니다. 예를 들어서 단지명 까지만 보내고 getAllData라는 옵션을 true로 하여 보내면 그 단지의 동/호수/공시가격 정보를 모두 제공해준다거나, 그 단지 공시가격의 최대/최소 값을 제공해준다거나, 다양한 옵션들이 필요하다는 것을 깨달았습니다. 앞으로 이런 API를 설계할 때는 웹에서의 설계랑은 다르게 바라봐야할 것 같습니다.

#### NginX 웹서버 사용기

 이번 프로젝트에서 웹서버도 처음 사용해보았습니다. NginX를 사용한 덕분에 실제 서버가 실행되고 있는 포트를 숨길 수 있었고, express의 static 미들웨어로 정적 파일을 제공할 때 파일의 위치도 숨길 수 있었습니다. 또한 리버스 프록시라는 새로운 개념도 알 수 있었고, 즐거운 경험이었습니다.

#### 테스트 코드를 작성할 때의 또다른 문제점

 테스트 코드를 작성하면서 TDD를 비롯한 여러 가지 자료를 찾아보게 되었는데, 그러면서 생각해보니 테스트 코드도 사람이 작성하는 것이었습니다. 테스트를 통과하지 못하는게 완전히 개발 단계의 문제로만 치부할 수는 없었던 것이었습니다. 테스트 코드를 작성하는 단계에서부터 잘못된 것일 수도 있었습니다. 테스트 코드도 잘못된 부분을 찾아내는 단계가 필요할 것 같습니다.

#### MVC의 C

 이번 프로젝트에서 MVC구조가 옳게 적용되고 있는지에 대한 고민을 정말 많이 했던 것 같습니다. 컨트롤러에는 비즈니스 로직이 포함되면 안된다고 합니다. 비즈니스 로직이 대체 무엇인지 알아보는데에만 아주 많은 시간을 쓴 것 같습니다. 한 영어 문서를 해석해보면, 비즈니스 로직은 데이터베이스와 유저 인터페이스 사이의 정보 교환을 다루는 커스텀 규칙 또는 알고리즘이라고 합니다. 비즈니스 룰, 비즈니스 객체 등 비즈니스가 붙은 개념들이 함께 나와서 도통 이해가 가질 않았습니다. 어쨌든 비즈니스 로직 자체의 개념만 두고 바라보니 로그인 로직, 데이터를 처리해서 제공하는 로직 등이 모두 비즈니스 로직이라고 볼 수 있는 것 같았고, 제 프로젝트에서는 그러한 로직들은 모두 다 컨트롤러에 포함되어 있었습니다. 프로젝트 구조를 리팩토링 하기에는 너무 늦어버린 상황이어서 다음 프로젝트에 적용해볼 수 있는, MVC이 규칙을 더 철저히 지킬 수 있는 새로운 구조가 필요했습니다. 그러던 중 [이러한 글]([https://velog.io/@hopsprings2/%EA%B2%AC%EA%B3%A0%ED%95%9C-node.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-%EC%84%A4%EA%B3%84%ED%95%98%EA%B8%B0](https://velog.io/@hopsprings2/견고한-node.js-프로젝트-아키텍쳐-설계하기))을 발견했습니다. 다음 프로젝트에 TypeScript와 함께 적용해 봐야겠습니다.

#### 중복은 나빠

 이번 프로젝트에서 중복되는 로직을 하나로 만드려는 노력을 정말 많이 한 것 같습니다. 중복되는 로직은 최대한 미들웨어로 분리하여 개발하였던 것 같습니다. 확실히 에러 수정이나 간단한 리팩토링 부분에서 상당히 편해지는 것을 느꼈습니다.

#### 관심사 분리에 대해

 이번 프로젝트에서는 관심사 분리라는 개념에 대해서 많이 생각해보았던 것 같습니다. 제대로 적용된거 같진 않지만, 최소한 서로 다른 부분임에도 하나가 수정되면 다른 것들도 수정해야하는 일이 발생하지는 않았다는 점에서 뿌듯한 것 같습니다. MVC도 관심사 분리 원칙을 따르는 구조라고 하는데, 확실히 각 부분을 개발할 때 다른 부분을 신경 쓸 필요 없이 현재 개발하는 부분에 집중할 수 있었던 것 같습니다.

#### API 명세는 어디에?

 예전 프로젝트에서는 API 명세를 구글 독스에다가 했었습니다. 그래서 이번 기회에 항상 해보고 싶었던 Swagger를 사용한 APi 명세를 해보았습니다. API문서를 작성하고 수정하는 작업은 Swagger Hub에서 이루어지므로 API 명세의 버전 관리가 가능해졌습니다. 하지만 최종적으로 API 명세는 깃허브에 올라가는데, 어드민과 사용자에게 Swagger UI를 응답해주기 위해서 프로젝트 내에 Swagger yaml 파일을 포함시키기 때문이었습니다. 그런데 이러한 구조에는 API문서가 수정되면 애플리케이션 전체를 배포하는 과정을 거쳐야 한다는 문제가 존재했습니다. 다음에는 다른 방식으로 제공할 수 있는 방법이 있는지, Swagger보다 좋은 API 명세 도구가 있는지 알아봐야겠습니다.

#### 웹 프론트엔드는 처음이지?

 웹 프론트엔드, 백엔드 둘 다 능숙히 다루는게 제 많은 목표 중 하나입니다. 그래서 이번 프로젝트에서 간단한 로그인, 회원가입, 메인페이지를 개발해보았습니다. 웹 프론트엔드는 처음이다 보니 레이아웃 나누기, 창 크기에 따라서 요소 크기 바꾸기, 탭 메뉴 등 HTML과 CSS를 작성할 때 굉장히 고생을 했던 것 같습니다. 자바스크립트 부분은 Node.js 덕분에 자바스크립트를 많이 다뤄보기도 했고, 프론트엔드 자바스크립트 코드는 작성해본적이 있어서 어렵지 않게 완성할 수 있었습니다. HTML이랑 CSS보다는 확실히 JS부분이 훨씬 재밌었던 것 같습니다.

#### GitFlow 적용기

 지금까지 친구들끼리 진행한 프로젝트에서도 혼자서 서버 개발을 맡아왔고, 이번 프로젝트도 혼자 진행하는 프로젝트여서 같은 서버 개발자들과 협업을 해본 경험이 없습니다. 그래도 협업에서 가장 많이 언급되는 것 중 하나인 GitFlow 정도는 혼자서 해볼 수 있는 부분인 것 같아서 이번 프로젝트에서 적용해보기로 결정했습니다. 이런 워크플로우의 적용을 처음 해보기도 하고 혼자서 하다보니 release 브랜치를 분기하지 않는 등 많은 실수를 했지만, GitFlow가 무엇인지, 협업이 어떻게 흘러가는지 대략 감을 잡기에는 충분한 경험이었습니다. 또한 지금까지 크게 사용해보지 않았던 git의 여러 기능을 더 사용해볼 수 있었습니다.



## 마무리

 2달이라는 시간동안 실제 회사에서 진행한 프로젝트인 만큼 배운 점이 굉장히 많습니다. 빼먹고 적지 못한 점도 분명히 많을텐데 기억나는대로 하나씩 추가해보도록 하겠습니다. 항상 새로운 프로젝트를 할 때마다 이전 프로젝트보다 큰 발전을 위해서 고민하는데, 이번 프로젝트는 정말 만족스럽게 마무리된 것 같습니다. 다음 프로젝트는 어떨지 기대되네요.