---
layout : post
title : dotenv 패키지
subtitle : dotenv
categories : development
tags : nodejs
comments : false
---

# passport 모듈
세션과 쿠키 처리 등 작업이 많은 회원가입/로그인 처리는 검증된 모듈을 사용하는 것이 좋다. passport 모듈이 그 역할을 해준다. 또한 흔히 사용하는 카카오 로그인, 구글 로그인 등 기존의 SNS 서비스 계정을 통한 로그인도 passport를 통해서 해결이 가능하다.

# 미들웨어들
1. passport.initialize() : request 객체에 passport 설정을 심는다.

2. passport.session() : request.session 객체에 passport 정보를 저장한다. request.session 객체는 express-session에서 생성하는 것이므로 passport 미들웨어는 express-session 미들웨어보다 아래에 위치해야 한다.

# passport.serializeUser, passport.deserializeUser
예제코드
```javascript
const local = require('./localStrategy');
const kakao = require('./kakaoStrategy');
const {User} = require('../models');

module.exports = (passport) => {
    passport.serializeUser((user, done) => {
        done(null, user.id);
    });

    passport.deserializeUser((id, done) => {
        User.find({where : {id}})
        .then(user => done(null, user))
        .catch(err => done(err));
    });

    local(passport);

    kakao(passport);
};
```
1. passport.serializeUser : req.session 객체에 어떤 데이터를 저장할지 선택한다.

    done 함수의 첫 번째 인자는 에러 발생 시 사용하는 것이므로 두 번째 인자가 중요하다. 예제를 보면 매개변수로 user를 받아 done 함수에 두 번째 인자로 user.id를 넘기고 있다. 
    
    세션에 사용자 정보를 모두 저장하는 것은 데이터 일관성에 문제가 발생하고, 세션의 용량이 커지기 때문에 사용자 정보 중 id만 저장하라고 명령한 것이다.

2. passport.deserializeUser : 매 요청 시 실행된다. passport.session() 미들웨어가 이 메소드를 호출한다. serializeUser 메소드가 세션에 저장했던 아이디를 받아 데이터베이스에서 사용자 정보를 조회한다. 예제의 경우에는 조회한 결과를 req.user에 저장하므로 req.user를 통해 로그인한 사용자의 정보를 가져올 수 있다.

#### 한마디로 정리
serializeUser는 사용자 정보 객체를 세션에 아이디로 저장하는 것이고, deserializeUser는 세션에 저장한 아이디를 통해 사용자 정보 객체를 불러오는 것이다.