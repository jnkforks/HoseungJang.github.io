---
layout : post
title : Multer 모듈
subtitle : 이미지 업로드 구현하기
categories : development
tags : nodejs
comments : false
---

# Multer 모듈
이미지 업로드는 보통 input[type=file] 태그와 form 태그를 통해서 업로드한다. form의 인코딩 타입은 multipart/form-data 인 경우가 많다.

이런 형식의 데이터는 multipart 처리용 모듈을 통해 처리할 수 있다. 대표적인 것이 Multer 이다.

```javascript
//routes/post.js
const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const {Post, Hashtag, User} = require('../models');
const {isLoggedIn} = require('./middlewares');

//1
const router = express.Router();
fs.readdir('uploads', (error) => {
    if (error) {
        console.error('uploads 폴더가 없어 uploads 폴더를 생성합니다.');
        fs.mkdirSync('uploads');
    }
});
//1
//2
const upload = multer({
    storage : multer.diskStorage({
        destination(req, file, cb) {
            cb(null, 'uploads/');
        },
        filename(req, file, cb) {
            const ext = path.extname(file.originalname);
            cb(null, path.basename(file.originalname, ext) + new Date().valueOf() + ext);
        },
    }),
    limits : {fileSize : 5 * 1024 * 1024},
});
//2
//3
router.post('/img', isLoggedIn, upload.single('img'), (req, res) => {
    console.log(req.file);
    res.json({url : `img/${req.file.filename}`});
});
//3
//4
const upload2 = multer();
router.post('/', isLoggedIn, upload2.none(), async (req, res, next) => {
    try {
        const post = await Post.create({
            content : req.body.content,
            img : req.body.url,
            userId : req.user.id,
        });
        const hashtags = req.body.content.match(/#[^\s]*/g);
        if (hashtags) {
            const result = await Promise.all(hashtags.map(tag => Hashtag.findOrCreate({
                where : {title : tag.slice(1).toLowerCase()},
            })));
            await post.addHashtags(result.map(r => r[0]));
        }
        res.redirect('/');
    } catch (error) {
        console.error(error);
        next(error);
    }
});
module.exports = router;
//4
```
1. fs 모듈은 이미지를 업로드할 uploads 폴더가 없을 때 uploads 폴더를 생성한다.

2. Multer 모듈에 옵션을 주어서 upload 변수에 대입하였다. upload는 미들웨어를 만드는 객체가 된다. 옵션으로 storage 와 limits 속성을 주었는데, storage 에는 파일 저장 방식과 경로, 파일명 등을 설정할 수 있다.<br><br>diskStorage 를 사용해 이미지가 서버 디스크에 저장되도록 했고, diskStorage 의 destination 메소드로 저장 경로를 nodebird 폴더 안에 uploads 폴더로 지정했다. 파일명은 filename 메소드로 기존 이름 (file.originalname) 에 업로드 날짜값 (new Date().valueOf) 과 기존 확장자 (path.extname) 을 붙이도록 설정했다.<br><br>limits 속성은 최대 이미지 파일 용량 허용치 (바이트 단위) 를 의미한다. 현재 10MB 로 설정하였다.<br><br>upload 변수는 미들웨어를 만드는 여러 가지 메소드를 가지고 있다. 자주 쓰이는 것은 single, array, fields, none 이다.<br><br>single은 하나의 이미지를 업로드할 때 사용하고, req.file 객체를 생성한다.<br><br>array 와 fields 는 여러 개의 이미지를 업로드할 때 사용하며, req.files 객체를 생성한다. array 와 fields 의 차이점은 이미지를 업로드한 body 속성 개수이다. 하나의 body 속성에 이미지를 여러 개 업로드했다면 array, 여러 개의 body 속성에 이미지를 하나씩 업로드 했다면 fields 를 사용한다.<br><br>none 은 이미지를 올리지 않고 데이터만 multipart 형식으로 전송했을 때 사용한다.

3. 이미지 업로드를 처리하는 라우터이다. single 미들웨어를 사용하고 있다. single 메소드에 이미지가 담긴 req.body 속성의 이름을 적어주었다. single 메소드가 생성하는 req.file 객체는 다음과 같다.

    {
        fieldname : 'img',
        originalname : 'nodejs.png',
        encoding : '7bit',
        mimetype : 'image/png',
        destination : 'uploads/',
        filename : 'nodejs1514197844339.png',
        path : 'uploads\\nodejs1514197844339.png',
        size : 53357,
    }

    req.file.filename 을 클라이언트로 보내서 게시글을 등록할 때 사용할 수 있게 한다.

4. 게시글 업로드를 처리하는 라우터이다. 이미지를 업로드 했다면 이미지 url 이 req.body.url 로 전송된다. 데이터 형식이 multipart 이지만 이미지가 들어있지 않으므로 none 을 사용했다. 이미지 주소가 온 것이지 이미지 자체가 온 것이 아니다. post.addHashtags 메소드로 게시글과 해시태그의 관계를 PostHashtag 테이블에 넣는다.

### 실제 서버 운영 시
Multer 모듈은 이미지를 서버 디스크에 저장한다. 간단하기는 하지만, 서버에 문제가 생겼을 때 이미지가 제공되지 않거나 날아가 버릴 수도 있다. AWS S3이나 Cloud Storage 같은 정적 파일 제공 서비스를 사용하여 이미지를 따로 저장하고 제공하는 것이 좋다.

multer-s3 이나 multer-google-storage 같은 모듈을 사용하면 된다.